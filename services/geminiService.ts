
import { GoogleGenAI } from "@google/genai";
import { TradeRecord, ExpenseRecord, CoinSaleRecord } from "../types";
import { formatCurrency } from "../utils/currency";

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

const getContextString = (history: TradeRecord[], expenses: ExpenseRecord[], coinSales: CoinSaleRecord[]) => {
  const tradesContext = history.slice(-30).map(h => 
    `[${h.timestamp}] ${h.fromNode} -> ${h.toNode}: +${formatCurrency(h.profit)} (${h.packsCount} –ø–∞–∫., —Ü–µ–Ω–∞ –∑–∞ –ø–∞–∫: ${formatCurrency(h.pricePerPack)})`
  ).join('\n');

  const expensesContext = expenses.slice(-20).map(e => 
    `[${e.timestamp}] –¢—Ä–∞—Ç–∞ (${e.label}): -${formatCurrency(e.amount)}`
  ).join('\n');

  const salesContext = coinSales.slice(-15).map(s => 
    `[${s.timestamp}] –í—ã–≤–æ–¥: ${formatCurrency(s.amount)} –∑–∞ $${s.usdPrice}`
  ).join('\n');

  return `
–ö–û–ù–¢–ï–ö–°–¢ –ò–ì–†–û–ö–ê:
- –õ–æ–∫–∞—Ü–∏—è: –ü–æ–ª—å—à–∞ (–ö—É—Ä—Å: 1 USD = 4.10 PLN). 
- –õ–∏–º–∏—Ç –∫–∞—Ä–∞–≤–∞–Ω–∞: –ú–∞–∫—Å–∏–º—É–º 3 –ø–∞–∫–∞ –∑–∞ 1 —Ä–µ–π—Å. –í—Å–µ —Ä–∞—Å—á–µ—Ç—ã —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤ —Å—Ç—Ä–æ–π –∏—Å—Ö–æ–¥—è –∏–∑ —ç—Ç–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è.
- –ó–∞–ø—Ä–µ—Ç: –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ–≤–µ—Ç—É–π –Ω–∞–Ω–∏–º–∞—Ç—å –æ—Ö—Ä–∞–Ω—É –∏–ª–∏ –≤—Å—Ç—É–ø–∞—Ç—å –≤ –≥–∏–ª—å–¥–∏–∏ –¥–ª—è –∑–∞—â–∏—Ç—ã. –¢–æ–ª—å–∫–æ —á–∏—Å—Ç–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞, –ª–æ–≥–∏—Å—Ç–∏–∫–∞ –∏ —Ç–∞–π–º-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç.

–ò–°–¢–û–†–ò–Ø –û–ü–ï–†–ê–¶–ò–ô (—Å –º–µ—Ç–∫–∞–º–∏ –≤—Ä–µ–º–µ–Ω–∏):
–¢–û–†–ì–û–í–õ–Ø:
${tradesContext || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}

–ó–ê–ö–£–ü–ö–ò:
${expensesContext || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}

–ü–†–û–î–ê–ñ–ê –í–ê–õ–Æ–¢–´:
${salesContext || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}
  `;
};

export const getTradingAdvice = async (
  history: TradeRecord[], 
  expenses: ExpenseRecord[] = [], 
  coinSales: CoinSaleRecord[] = []
) => {
  const context = getContextString(history, expenses, coinSales);

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: `–í—ã–ø–æ–ª–Ω–∏ –≥–ª—É–±–æ–∫–∏–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞—É–¥–∏—Ç –º–æ–µ–π —Ç–æ—Ä–≥–æ–≤–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ Ashes of Creation.
      
      –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∞–Ω–∞–ª–∏–∑—É:
      1. üáµüá± **–≠–∫–æ–Ω–æ–º–∏–∫–∞ –ü–æ–ª—å—à–∏**: –ü–µ—Ä–µ—Å—á–∏—Ç–∞–π –≤—Å—é —á–∏—Å—Ç—É—é –ø—Ä–∏–±—ã–ª—å –≤ PLN. –û—Ü–µ–Ω–∏ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –≤ –∑–ª–æ—Ç—ã—Ö –≤ —á–∞—Å (–µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç).
      2. üöõ **–õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞—É–¥–∏—Ç (–õ–∏–º–∏—Ç 3 –ø–∞–∫–∞)**: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π, –Ω–∞—Å–∫–æ–ª—å–∫–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —è –∏—Å–ø–æ–ª—å–∑—É—é –ª–∏–º–∏—Ç –≤ 3 –ø–∞–∫–∞. –°—Ä–∞–≤–Ω–∏ –º–∞—Ä—à—Ä—É—Ç—ã –ø–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—é "–ó–æ–ª–æ—Ç–æ –∑–∞ 1 –ø–∞–∫ / –í—Ä–µ–º—è".
      3. üìâ **–ê–Ω–∞–ª–∏–∑ –∑–∞—Ç—Ä–∞—Ç –∏ ROI**: –û—Ü–µ–Ω–∏ –∑–∞–∫—É–ø–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤. –ù–∞—Å–∫–æ–ª—å–∫–æ –æ–Ω–∏ —Å–Ω–∏–∂–∞—é—Ç –∏—Ç–æ–≥–æ–≤—É—é –º–∞—Ä–∂—É? –°—Ç–æ–∏—Ç –ª–∏ –ø–æ–∫—É–ø–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã –∏–ª–∏ –≤—ã–≥–æ–¥–Ω–µ–µ —Ç—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞ —Å–±–æ—Ä?
      4. üïí **–¢–∞–π–º–∏–Ω–≥**: –ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ –≤—Ä–µ–º—è —Å–¥–µ–ª–æ–∫. –ï—Å—Ç—å –ª–∏ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç—å –≤ –ø—Ä–∏–±—ã–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫?
      5. üß≠ **–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω**: –î–∞–π 3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —à–∞–≥–∞ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞ –≤ PLN –±–µ–∑ —É—á–µ—Ç–∞ –æ—Ö—Ä–∞–Ω—ã.
      
      –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π —Å—Ç–∏–ª—å. –ò—Å–ø–æ–ª—å–∑—É–π Markdown.
      
      ${context}`,
      config: {
        systemInstruction: "–¢—ã ‚Äî –ì–ª–∞–≤–Ω—ã–π –ö–∞–∑–Ω–∞—á–µ–π. –¢–≤–æ–π –º–æ–∑–≥ ‚Äî —ç—Ç–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä. –¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –≤—Ä–µ–º—è, –¥–µ–Ω—å–≥–∏ –∏ –ª–æ–≥–∏—Å—Ç–∏–∫—É. –¢—ã –ø–æ–Ω–∏–º–∞–µ—à—å, —á—Ç–æ –≤—Ä–µ–º—è ‚Äî —ç—Ç–æ –¥–µ–Ω—å–≥–∏ –≤ –∑–ª–æ—Ç—ã—Ö.",
        tools: [{googleSearch: {}}],
        temperature: 0.7,
      }
    });

    return response.text || "–û—Ä–∞–∫—É–ª –Ω–µ —Å–º–æ–≥ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–≤–∏—Ç–∫–∏.";
  } catch (error) {
    console.error("Gemini Error:", error);
    return "–°–≤—è–∑—å —Å –º–∞–≥–∏—á–µ—Å–∫–∏–º —Å–µ—Ä–≤–µ—Ä–æ–º –ø—Ä–µ—Ä–≤–∞–Ω–∞.";
  }
};

export const startOracleChat = (history: TradeRecord[], expenses: ExpenseRecord[], coinSales: CoinSaleRecord[]) => {
  const context = getContextString(history, expenses, coinSales);
  
  return ai.chats.create({
    model: 'gemini-3-pro-preview',
    config: {
      systemInstruction: `–¢—ã ‚Äî –û—Ä–∞–∫—É–ª-–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. –¢—ã –æ–±—â–∞–µ—à—å—Å—è —Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º —Ç–æ—Ä–≥–æ–≤—Ü–µ–º –∏–∑ –ü–æ–ª—å—à–∏.
      –£ –Ω–µ–≥–æ –∂–µ—Å—Ç–∫–∏–π –ª–∏–º–∏—Ç ‚Äî 3 –ø–∞–∫–∞ –Ω–∞ –∫–∞—Ä–∞–≤–∞–Ω. 
      –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞:
      1. –†–∞—Å—á–µ—Ç–∞—Ö –ø—Ä–∏–±—ã–ª–∏ –≤ PLN (–∫—É—Ä—Å 4.1).
      2. –ê–Ω–∞–ª–∏–∑–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç –º–µ–∂–¥—É –µ–≥–æ –∑–∞–ø–∏—Å—è–º–∏.
      3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –ø–æ–¥ –ª–∏–º–∏—Ç 3 –ø–∞–∫–∞.
      
      –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –æ—Ö—Ä–∞–Ω—É –∏–ª–∏ –∑–∞—â–∏—Ç—É. 
      –ï—Å–ª–∏ –æ–Ω —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "–ö–∞–∫ –¥–µ–ª–∞?", –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –µ–≥–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏ –æ—Ç–≤–µ—á–∞–π: "–¢–≤–æ–π –¥–æ—Ö–æ–¥ –≤ PLN –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å —Å–æ—Å—Ç–∞–≤–∏–ª..." –∏–ª–∏ "–¢—ã —Ç—Ä–∞—Ç–∏—à—å —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –Ω–∞ —Ä–µ—Å—É—Ä—Å—ã".
      –ë—É–¥—å —Ç–æ—á–Ω—ã–º, —Ü–∏–Ω–∏—á–Ω–æ —Ä–∞—Å—á–µ—Ç–ª–∏–≤—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º. –ò—Å–ø–æ–ª—å–∑—É–π Markdown.
      
      –í–æ—Ç –µ–≥–æ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
      ${context}`,
      tools: [{googleSearch: {}}],
    },
  });
};
