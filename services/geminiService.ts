
import { GoogleGenAI } from "@google/genai";
import { TradeRecord, ExpenseRecord, CoinSaleRecord } from "../types";
import { formatCurrency } from "../utils/currency";

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

export const getTradingAdvice = async (
  history: TradeRecord[], 
  expenses: ExpenseRecord[] = [], 
  coinSales: CoinSaleRecord[] = []
) => {
  if (history.length === 0) return "–ù–∞—á–Ω–∏—Ç–µ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Å–≤–æ–∏ —Å–¥–µ–ª–∫–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–æ–≤–µ—Ç—ã –æ—Ç –ò–ò!";

  const tradesContext = history.slice(-20).map(h => 
    `${h.fromNode} -> ${h.toNode}: +${formatCurrency(h.profit)}`
  ).join('\n');

  const expensesContext = expenses.slice(-10).map(e => 
    `–¢—Ä–∞—Ç–∞ (${e.label}): -${formatCurrency(e.amount)}`
  ).join('\n');

  const salesContext = coinSales.slice(-10).map(s => 
    `–ü—Ä–æ–¥–∞–∂–∞ –º–æ–Ω–µ—Ç: ${formatCurrency(s.amount)} –∑–∞ $${s.usdPrice}`
  ).join('\n');

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-flash-preview',
      contents: `–í—ã ‚Äî –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –°–æ–≤–µ—Ç–Ω–∏–∫ –¢–æ—Ä–≥–æ–≤–æ–π –ì–∏–ª—å–¥–∏–∏ –í–µ—Ä—Ä—ã –∏ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ê–Ω–∞–ª–∏—Ç–∏–∫. 
      –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∏—Å—Ç–æ—Ä–∏—é —Å–¥–µ–ª–æ–∫, —Ç—Ä–∞—Ç –∏ –ü–†–û–î–ê–ñ –º–æ–Ω–µ—Ç –∑–∞ —Ä–µ–∞–ª—å–Ω—É—é –≤–∞–ª—é—Ç—É.
      
      –í–∞—à –æ—Ç–≤–µ—Ç –î–û–õ–ñ–ï–ù –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–∞–∑–¥–µ–ª—ã:
      1. üèÜ **–ó–æ–ª–æ—Ç–æ–π –ü—É—Ç—å**: –°–∞–º—ã–π –≤—ã–≥–æ–¥–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç.
      2. üìâ **–ê–Ω–∞–ª–∏–∑ –†–∞—Å—Ö–æ–¥–æ–≤**: –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞–∫—É–ø–æ–∫ —Å—ã—Ä—å—è.
      3. üíµ **–í–∞–ª—é—Ç–Ω—ã–π –ú–æ—Å—Ç**: –ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏–≥—Ä–æ–≤–æ–≥–æ –∑–æ–ª–æ—Ç–∞ –≤ USD. 
         - –†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ —Å—Ä–µ–¥–Ω–∏–π –∫—É—Ä—Å (–∑–æ–ª–æ—Ç–æ/$). 
         - –û—Ü–µ–Ω–∏—Ç–µ "–ø—Ä–æ—Ñ–∏—Ç–Ω–æ—Å—Ç—å" –∏–≥—Ä–æ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏: –∫–∞–∫–æ–π –º–∞—Ä—à—Ä—É—Ç –≤—ã–≥–æ–¥–Ω–µ–µ –≤—Å–µ–≥–æ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –≤—ã–≤–æ–¥–∞ –≤ USD.
      4. üõ°Ô∏è **–°—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞**: –ö–∞–∫ —É–≤–µ–ª–∏—á–∏—Ç—å —á–∏—Å—Ç—É—é –ø—Ä–∏–±—ã–ª—å –≤ USD.
      
      –î–∞–Ω–Ω—ã–µ:
      –¢–û–†–ì–û–í–õ–Ø:
      ${tradesContext}
      
      –†–ê–°–•–û–î–´:
      ${expensesContext}
      
      –≠–ö–°–ü–û–†–¢ (USD):
      ${salesContext}`,
      config: {
        systemInstruction: "–í—ã —ç–ª–∏—Ç–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –º–∏—Ä–∞ Ashes of Creation. –ü–∏—à–∏—Ç–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ë—É–¥—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã –≤ —Ü–∏—Ñ—Ä–∞—Ö –∏ —Å–æ–≤–µ—Ç–∞—Ö –ø–æ –≤—ã–≤–æ–¥—É –ø—Ä–∏–±—ã–ª–∏ –≤ —Ä–µ–∞–ª—å–Ω—É—é –≤–∞–ª—é—Ç—É.",
        temperature: 0.8,
      }
    });

    return response.text || "–°–≤–∏—Ç–∫–∏ –ø—É—Å—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–∑–∂–µ.";
  } catch (error) {
    console.error("Gemini Error:", error);
    return "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å –¢–æ—Ä–≥–æ–≤–æ–π –ì–∏–ª—å–¥–∏–µ–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∞–≥–∏—á–µ—Å–∫–∏–π –∫—Ä–∏—Å—Ç–∞–ª–ª (API Key).";
  }
};
